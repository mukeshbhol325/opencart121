image: maven:3.9.6-eclipse-temurin-17

stages:
  - test

variables:
  MAVEN_OPTS: "-Djava.awt.headless=true"
  _JAVA_OPTIONS: "-Djava.awt.headless=true"
  SE_EVENT_BUS_HOST: selenium-hub
  SE_EVENT_BUS_PUBLISH_PORT: 4442
  SE_EVENT_BUS_SUBSCRIBE_PORT: 4443

services:
  - name: selenium/hub:4.19.1
    alias: selenium-hub
  - name: selenium/node-chrome:4.19.1
    alias: chrome

test:
  stage: test
  before_script:
    - java -version
    - mvn -version
    - ls -l
    # Improved Selenium Grid health check
    - |
      echo "Waiting for Selenium Grid..."
      MAX_ATTEMPTS=30
      ATTEMPT=0
      until curl -sf http://selenium-hub:4444/status | grep -q '"ready":true'; do
        ATTEMPT=$((ATTEMPT+1))
        if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
          echo "ERROR: Selenium Grid failed to start"
          exit 1
        fi
        echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Waiting..."
        sleep 2
      done
      echo "âœ“ Selenium Grid is ready!"
  
  script:
    - mvn clean test -Dselenium.hub.url=http://selenium-hub:4444/wd/hub
  
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - target/surefire-reports/
      - target/screenshots/
    reports:
      junit: target/surefire-reports/TEST-*.xml